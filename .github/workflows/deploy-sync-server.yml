name: Deploy Sync Server

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.1.0)"
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Sync Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release -p diaryx_sync_server

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: sync-server-binary
          path: target/release/diaryx_sync_server

  deploy:
    name: Deploy to VPS
    needs: [build]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: sync-server-binary
          path: artifact/

      - name: Copy binary and deploy script to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: artifact/diaryx_sync_server,scripts/deploy-sync-server.sh
          target: /tmp/diaryx-deploy
          strip_components: 1

      - name: Deploy and restart
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script_stop: true
          script: bash /tmp/diaryx-deploy/deploy-sync-server.sh
